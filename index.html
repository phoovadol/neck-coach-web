<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Neck Exercise Coach</title>

  <!-- ‡πÇ‡∏´‡∏•‡∏î Mediapipe -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>

  <style>
    body { font-family: sans-serif; text-align: center; background: #eef2f3; }
    video { border-radius: 12px; margin-top: 10px; }
    #controls { margin: 15px; }
    select, button { padding: 8px; margin: 5px; border-radius: 8px; }
    #counter { font-size: 20px; margin-top: 10px; }
  </style>
</head>
<body>
  <h2>üßò‚Äç‚ôÄÔ∏è Neck Exercise Coach</h2>
  <video id="video" width="640" height="480" autoplay></video>

  <div id="controls">
    <select id="exercise">
      <option value="chin_tuck">Chin Tuck</option>
      <option value="side_stretch">Side Neck Stretch</option>
      <option value="rotation">Neck Rotation</option>
    </select>
    <button id="startBtn">‡πÄ‡∏£‡∏¥‡πà‡∏°</button>
    <button id="stopBtn">‡∏´‡∏¢‡∏∏‡∏î</button>
  </div>

  <div id="counter">‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: 0</div>
  <audio id="beep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

  <script>
    const video = document.getElementById('video');
    const counter = document.getElementById('counter');
    const beep = document.getElementById('beep');
    let currentExercise = 'chin_tuck';
    let count = 0;
    let detecting = false;
    let lastState = false;

    document.getElementById('exercise').addEventListener('change', e => {
      currentExercise = e.target.value;
      count = 0;
      counter.textContent = "‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: 0";
    });

    document.getElementById('startBtn').addEventListener('click', () => detecting = true);
    document.getElementById('stopBtn').addEventListener('click', () => detecting = false);

    navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
      video.srcObject = stream;
    });

    // ‚úÖ ‡πÉ‡∏ä‡πâ FaceMesh (‡∏à‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏®‡∏µ‡∏£‡∏©‡∏∞)
    const faceMesh = new FaceMesh.FaceMesh({
      locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
    });

    faceMesh.setOptions({
      maxNumFaces: 1,
      refineLandmarks: true,
      minDetectionConfidence: 0.5,
      minTrackingConfidence: 0.5
    });

    faceMesh.onResults(results => {
      if (!detecting) return;

      const landmarks = results.multiFaceLandmarks?.[0];
      if (!landmarks) return;

      // ‡∏à‡∏∏‡∏î‡∏´‡∏•‡∏±‡∏Å‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤ (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì)
      const nose = landmarks[1];
      const leftEar = landmarks[234];
      const rightEar = landmarks[454];
      const chin = landmarks[152];
      const forehead = landmarks[10];

      let triggered = false;

      // üíÜ‚Äç‚ôÇÔ∏è Chin Tuck: ‡∏Ñ‡∏≤‡∏á‡∏ñ‡∏≠‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏≤ -> ‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏¢‡∏∞‡∏Ñ‡∏≤‡∏á‡∏Å‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡∏≤‡∏Å‡∏•‡∏î‡∏•‡∏á
      if (currentExercise === 'chin_tuck') {
        const diff = Math.abs(chin.z - forehead.z);
        if (diff < 0.015) triggered = true;
      }

      // ‚ÜîÔ∏è Side Stretch: ‡πÄ‡∏≠‡∏µ‡∏¢‡∏á‡∏®‡∏µ‡∏£‡∏©‡∏∞‡∏ã‡πâ‡∏≤‡∏¢/‡∏Ç‡∏ß‡∏≤
      else if (currentExercise === 'side_stretch') {
        const angle = rightEar.y - leftEar.y;
        if (Math.abs(angle) > 0.05) triggered = true;
      }

      // üîÑ Rotation: ‡∏´‡∏±‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡∏ß‡∏≤
      else if (currentExercise === 'rotation') {
        const horizontal = rightEar.x - leftEar.x;
        if (Math.abs(horizontal) < 0.35) triggered = true;
      }

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö transition (‡∏à‡∏≤‡∏Å false ‚Üí true ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
      if (triggered && !lastState) {
        count++;
        beep.play();
        counter.textContent = `‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${count}`;
      }

      lastState = triggered;
    });

    const camera = new Camera(video, {
      onFrame: async () => {
        await faceMesh.send({ image: video });
      },
      width: 640,
      height: 480
    });

    camera.start();
  </script>
</body>
</html>
